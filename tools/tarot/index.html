<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â°îÁΩóÁâåÂç†Âçú</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a0f1f linear-gradient(45deg, #2d1b36 0%, #1a0f1f 100%);
            color: #f0e6f5;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            font-size: 16px;
            padding: 10px;
        }
    
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
        }
    
        h2, h3 {
            color: #e8d8ff;
            text-shadow: 0 0 10px rgba(232, 216, 255, 0.3);
            margin-bottom: 1.5em;
        }
    
        .input-section {
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
        }
    
        #query {
            width: 80%;
            padding: 12px 20px;
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #635276;
            border-radius: 25px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
    
        #query:focus {
            outline: none;
            border-color: #9d7dbf;
            box-shadow: 0 0 15px #9d7dbf;
        }
    
        button {
            background: #6a4c93;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    
        button:hover {
            background: #8b6db0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(106, 76, 147, 0.4);
        }
    

        #cardSelection {
            text-align: center;
            margin-top: 2rem;
        }
    

        .card {
            perspective: 800px; 
            width: 120px;
            height: 200px;
            margin: 0 auto;
            position: relative; 
        }


        .card-inner {
            position: absolute;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            transform-origin: center center; 
        }


        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }


        .card:hover {
            z-index: 2 !important;
        }

        .card.flipped {
            z-index: 1;
        }


        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform-style: preserve-3d;
        }

        .card-back {
            background: #4a306d;
            transform: rotateY(0deg);
            display: flex;
            border: 2px solid #7b5c9e;
        }

        .card-front {
            background: #f0e6f5;
            transform: rotateY(180deg);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card-front.reversed {
            transform: rotateY(180deg) rotate(180deg); 
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 25px; 
            padding: 20px;
            perspective: 1000px; 
        }
    

        .selection-status {
            color: #b39ddb;
            font-size: 1.1em;
            margin: 20px 0;
            padding: 10px;
            background: rgba(179, 157, 219, 0.1);
            border-radius: 8px;
        }
    

        #result {
            visibility: hidden;
            margin-top: 2rem;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;

            white-space: pre-wrap;
            border: 1px solid #4a306d;
            transition: all 0.3s ease;
        }
    
    
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
    
        #result[data-loading="true"]::before {
            content: "üîÆ";
            animation: pulse 1.5s infinite;
            font-size: 2em;
            display: block;
            text-align: center;
        }
        
        #result::after {
            content: '‚ñå';
            animation: blink 1s step-end infinite;
            color: #666;
        }
        
        @keyframes blink {
            50% { opacity: 0 }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="input-section" id="inputSection">
            <h2>‰ªäÊó•ËøêÂäøÂ°îÁΩóÂç†Âçú</h2>
            <input type="text" id="query" placeholder="ËØ∑ËæìÂÖ•ÊÉ≥Âç†ÂçúÁöÑÊñπÈù¢ÔºàÂ¶ÇÂÅ•Â∫∑„ÄÅÂ∑•‰Ωú„ÄÅÂ≠¶‰π†...Ôºâ">
            <button onclick="startDivination()">ÂºÄÂßãÂç†Âçú</button>
        </div>

        <div id="cardSelection" style="display: none;">
            <h3>ËØ∑‰æùÊ¨°ÈÄâÊã©‰∏âÂº†Â°îÁΩóÁâåÔºö</h3>
            <div class="selection-status" id="selectionStatus">Ê≠£Âú®ÈÄâÊã©ËÉΩÈáèÁâåÔºà1/3Ôºâ</div>
            <div class="cards-container" id="cardsContainer"></div>
            <button id="interpretBtn" onclick="interpretCards()" disabled>ÂºÄÂßãËß£Áâå</button>
        </div>

        <div id="result"></div>
        <br>
        <br>
        <br>
    </div>
<script src="./marked.min.js"></script>
<script>
    // Âç°Áâá
    const card_name = ['ÊÑö‰∫∫', 'È≠îÊúØÂ∏à', 'Â•≥Á•≠Á•Ä', 'Â•≥Áöá', 'ÁöáÂ∏ù', 'ÊïôÁöá', 'ÊÅã‰∫∫',
                'ÊàòËΩ¶', 'ÂäõÈáè', 'ÈöêÂ£´', 'ÂëΩËøê‰πãËΩÆ', 'Ê≠£‰πâ', 'ÂÄíÂêä‰∫∫', 'Ê≠ªÁ•û',
                'ËäÇÂà∂', 'È≠îÈ¨º', 'È´òÂ°î', 'ÊòüÊòü', 'Êúà‰∫Æ', 'Â§™Èò≥', 'ÂÆ°Âà§', '‰∏ñÁïå'];
                
    const tarotCards = card_name.map((name, id) => ({ id, name }));

    // API
    function checkAPIKey() {
        if (!localStorage.getItem('apikey')) {
            const key = prompt('ËØ∑ËæìÂÖ•ÊÇ®ÁöÑDeepSeek APIÂØÜÈí•Ôºö');
            if (key) localStorage.setItem('apikey', key);
            else alert('ÈúÄË¶ÅAPIÂØÜÈí•ÊâçËÉΩ‰ΩøÁî®ÊúçÂä°ÔºÅ');
        }
    }
    checkAPIKey();

    let selectedCards = [];

    function startDivination() {
        document.getElementById('inputSection').style.display = 'none';
        document.getElementById('cardSelection').style.display = 'block';
        initCards();
        updateSelectionStatus();
    }

    function updateSelectionStatus() {
        const phases = ['ËÉΩÈáèÁâå', 'Âª∫ËÆÆÁâå', 'Ë≠¶Á§∫Áâå'];
        const currentStep = selectedCards.length;
        if (currentStep >= 3) {
            document.getElementById('selectionStatus').style.display = 'none';
            return;
        }
        document.getElementById('selectionStatus').innerHTML = 
            `Ê≠£Âú®ÈÄâÊã©${phases[currentStep]}Ôºà${currentStep + 1}/3Ôºâ`;
    }

    function initCards() {
        const container = document.getElementById('cardsContainer');
        container.innerHTML = '';
        // Êâì‰π±tarotCards
        shuffledtarotCards = tarotCards.sort(() => Math.random() - 0.5);
        shuffledtarotCards.forEach(card => {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card';
            cardDiv.innerHTML = `
                <div class="card-inner">
                    <img src="assets/cover.jpg" class="card-back">
                    <img src="assets/${card.id}.gif" class="card-front">
                </div>
            `;
            
            cardDiv.onclick = () => {
                if (selectedCards.length >= 3 || cardDiv.classList.contains('flipped')) return;
                
                const isReversed = Math.random() < 0.5;
                cardDiv.classList.add('flipped');
                if (isReversed) {
                    cardDiv.querySelector('.card-front').classList.add('reversed');
                }
                
                selectedCards.push({
                    ...card,
                    reversed: isReversed,
                    role: ['ËÉΩÈáè', 'Âª∫ËÆÆ', 'Ë≠¶Á§∫'][selectedCards.length] // Ê†πÊçÆÂΩìÂâçÊï∞ÈáèËá™Âä®ÂàÜÈÖçËßíËâ≤
                });
                
                updateSelectionStatus();
                document.getElementById('interpretBtn').disabled = selectedCards.length !== 3;
            };
            container.appendChild(cardDiv);
        });
    }

    // ÊèêÁ§∫ËØçÁîüÊàêÂáΩÊï∞
    function getCurrentTimeDescription() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();

        let period;
        if (hours >= 0 && hours < 6) period = "ÂáåÊô®";
        else if (hours < 12) period = "‰∏äÂçà";
        else if (hours < 18) period = "‰∏ãÂçà";
        else period = "Êôö‰∏ä";

        return `${period}${hours % 12 || 12}ÁÇπ${minutes}ÂàÜ`;
    }

    function get_prompt(aspect, cards) {
        return `‰Ω†ÊòØ‰∏ÄÂêç‰∏ìÊ≥®‰∫éÂ°îÁΩóÊØèÊó•ÊåáÂºïÁöÑÂç†ÂçúÂ∏àÔºåÊìÖÈïøÂ∞ÜÂ§ßÈòøÂ∞îÂç°ÈÇ£ÁöÑË±°ÂæÅÊÑè‰πâËΩ¨Âåñ‰∏∫Êó•Â∏∏ÁîüÊ¥ªÂª∫ËÆÆ„ÄÇ  
    ËØ∑Ê†πÊçÆÁî®Êà∑Êèê‰æõÁöÑ‰ªäÊó•ÊäΩÁâå‰ø°ÊÅØÔºå‰∏∫Áî®Êà∑ËøõË°åËß£ËØªÔºö  

    **1. Áî®Êà∑ÊäΩÁâå**Ôºö  
    - ÊäΩÁâåÊï∞ÈáèÔºö3Âº†(ËÉΩÈáè/Âª∫ËÆÆ/Ë≠¶Á§∫)
    - ÁâåÈù¢‰ø°ÊÅØÔºö
    1. ËÉΩÈáèÁâåÔºö${cards[0].name}${cards[0].reversed ? "ÈÄÜ‰Ωç" : "Ê≠£‰Ωç"}  
    2. Âª∫ËÆÆÁâåÔºö${cards[1].name}${cards[1].reversed ? "ÈÄÜ‰Ωç" : "Ê≠£‰Ωç"}  
    3. Ë≠¶Á§∫ÁâåÔºö${cards[2].name}${cards[2].reversed ? "ÈÄÜ‰Ωç" : "Ê≠£‰Ωç"}  
    - ÈôÑÂä†ÈúÄÊ±ÇÔºöÈúÄË¶ÅËÅöÁÑ¶ÁâπÂÆöÈ¢ÜÂüüÔºà${aspect}Ôºâ  

    **2. ‰Ω†ÁöÑËß£ËØª‰ªªÂä°**Ôºö  
    ‚ë† ‰ªäÊó•Ê∞îËøêÔºàÊ†∏ÂøÉËÉΩÈáèÂàÜÊûêÔºâ
    - Áî®‰∏ÄÂè•ËØùÊÄªÁªì‰ªäÊó•Êï¥‰ΩìÂü∫Ë∞ÉÔºàÂ¶Ç‚ÄúÁ™ÅÁ†¥Êó•‚Äù‚ÄúÁñóÊÑàÊó•‚Äù‚ÄúË∞®ÊÖéÊó•‚ÄùÔºâ  
    - ÁªìÂêàÁâåÈù¢Á¨¶Âè∑‰∏éÊ≠£ÈÄÜ‰ΩçÔºåËøõË°åËØ¶ÁªÜÂàÜÊûê 

    ‚ë° ÁªÜÂàÜÈ¢ÜÂüüÊåáÂºï ÔºàÂèØ‰ª•Ê†πÊçÆÂÜÖÂÆπÊõ¥ÊîπËøôÈÉ®ÂàÜÊ†áÈ¢òÔºâ
    - ËÉΩÈáè/Áé∞Áä∂Ôºö‰ªäÊó•‰∏ªÂØºËÉΩÈáèÂ¶Ç‰ΩïÂΩ±ÂìçÁîüÊ¥ª  
    - Âª∫ËÆÆ/Êú∫‰ºöÔºöÂÖ∑‰ΩìË°åÂä®ÊàñÂøÉÊÄÅË∞ÉÊï¥  
    - Ë≠¶Á§∫/ÊåëÊàòÔºöÈúÄËßÑÈÅøÁöÑÈ£éÈô©ÊàñÂøÉÊÄÅ  

    ‚ë¢ ‰ªäÊó•Ë°åÂä®Ê∏ÖÂçïÔºàÊ†πÊçÆÂΩìÂâçÊó∂Èó¥Ôºö${getCurrentTimeDescription()} ÁªôÂá∫ÂêàÁêÜÂª∫ËÆÆÔºâ
    - ÁªôÂá∫1-3Êù°ÂèØÁ´ãÂç≥ÊâßË°åÁöÑÂª∫ËÆÆÔºåÁî®‚Äú‚úÖ‚ÄùÂíå‚Äú‚ùå‚ÄùÂå∫ÂàÜÈºìÂä±‰∏éÈÅøÂÖç‰∫ãÈ°π„ÄÇ`;
    }

    async function interpretCards() {
        let btn = document.getElementById('interpretBtn');
        btn.disabled = true;
        let resultDiv = document.getElementById('result');
        resultDiv.style.visibility = 'visible';
        if (!localStorage.getItem('apikey')) return checkAPIKey();
        
        const aspect = document.getElementById('query').value || 'ÁªºÂêàËøêÂäø';
        const prompt = get_prompt(aspect, selectedCards);
        //console.log(prompt);
        resultDiv.innerHTML = 'üîÆ Ê≠£Âú®Ëß£ËØª‰∏≠...';

        try {
            const response = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('apikey')}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{ role: "user", content: prompt }],
                    stream: true  // ÂêØÁî®ÊµÅÂºè‰º†Ëæì
                })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let resultText = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                
                // Â§ÑÁêÜÊµÅÂºèÊï∞ÊçÆÂùó
                chunk.split('\n').forEach(line => {
                    if (line.startsWith('data: ') && !line.includes('[DONE]')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            const content = data.choices[0]?.delta?.content || '';
                            resultText += content;
                            // ÂÆûÊó∂Êõ¥Êñ∞ÊòæÁ§∫ÂÜÖÂÆπ
                            resultDiv.innerHTML = marked.parse(resultText + '‚ñå');  // Ê∑ªÂä†ÂÖâÊ†áÊïàÊûú
                        } catch (e) {
                            console.error('Ëß£ÊûêÈîôËØØ:', e);
                        }
                    }
                });
            }
            
            // ÊúÄÁªàËß£ÊûêÂÆåÊï¥ÁªìÊûú
            resultDiv.innerHTML = marked.parse(resultText);
        } catch (error) {
            resultDiv.innerHTML = '‚ö†Ô∏è Ëß£ÁâåÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñAPIÂØÜÈí•';
            console.error('Error:', error);
        }
    }
</script>
</body>
</html>