<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¡”ç½—ç‰Œå åœ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a0f1f linear-gradient(45deg, #2d1b36 0%, #1a0f1f 100%);
            color: #f0e6f5;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            font-size: 16px;
            padding: 10px;
        }
    
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
        }
    
        h2, h3 {
            color: #e8d8ff;
            text-shadow: 0 0 10px rgba(232, 216, 255, 0.3);
            margin-bottom: 1.5em;
        }
    
        .input-section {
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
        }
    
        #query {
            width: 80%;
            padding: 12px 20px;
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #635276;
            border-radius: 25px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
    
        #query:focus {
            outline: none;
            border-color: #9d7dbf;
            box-shadow: 0 0 15px #9d7dbf;
        }
    
        button {
            background: #6a4c93;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    
        button:hover {
            background: #8b6db0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(106, 76, 147, 0.4);
        }
    

        #cardSelection {
            text-align: center;
            margin-top: 2rem;
        }
    

        .card {
            perspective: 800px; 
            width: 120px;
            height: 200px;
            margin: 0 auto;
            position: relative; 
        }


        .card-inner {
            position: absolute;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            transform-origin: center center; 
        }


        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }


        .card:hover {
            z-index: 2 !important;
        }

        .card.flipped {
            z-index: 1;
        }


        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform-style: preserve-3d;
        }

        .card-back {
            background: #4a306d;
            transform: rotateY(0deg);
            display: flex;
            border: 2px solid #7b5c9e;
        }

        .card-front {
            background: #f0e6f5;
            transform: rotateY(180deg);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card-front.reversed {
            transform: rotateY(180deg) rotate(180deg); 
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 25px; 
            padding: 20px;
            perspective: 1000px; 
        }
    

        .selection-status {
            color: #b39ddb;
            font-size: 1.1em;
            margin: 20px 0;
            padding: 10px;
            background: rgba(179, 157, 219, 0.1);
            border-radius: 8px;
        }
    

        #result {
            visibility: hidden;
            margin-top: 2rem;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;

            white-space: pre-wrap;
            border: 1px solid #4a306d;
            transition: all 0.3s ease;
        }
    
    
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
    
        #result[data-loading="true"]::before {
            content: "ğŸ”®";
            animation: pulse 1.5s infinite;
            font-size: 2em;
            display: block;
            text-align: center;
        }
        
        #result::after {
            content: 'â–Œ';
            animation: blink 1s step-end infinite;
            color: #666;
        }
        
        @keyframes blink {
            50% { opacity: 0 }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="input-section" id="inputSection">
            <h2>ä»Šæ—¥è¿åŠ¿å¡”ç½—å åœ</h2>
            <input type="text" id="query" placeholder="è¯·è¾“å…¥æƒ³å åœçš„æ–¹é¢ï¼ˆå¦‚å¥åº·ã€å·¥ä½œã€å­¦ä¹ ...ï¼‰">
            <button onclick="startDivination()">å¼€å§‹å åœ</button>
        </div>

        <div id="cardSelection" style="display: none;">
            <h3>è¯·ä¾æ¬¡é€‰æ‹©ä¸‰å¼ å¡”ç½—ç‰Œï¼š</h3>
            <div class="selection-status" id="selectionStatus">æ­£åœ¨é€‰æ‹©èƒ½é‡ç‰Œï¼ˆ1/3ï¼‰</div>
            <div class="cards-container" id="cardsContainer"></div>
            <button id="interpretBtn" onclick="interpretCards()" disabled>å¼€å§‹è§£ç‰Œ</button>
        </div>

        <div id="result"></div>
        <br>
        <br>
        <br>
    </div>
<script src="./marked.min.js"></script>
<script>
    // å¡ç‰‡
    const card_name = ['æ„šäºº', 'é­”æœ¯å¸ˆ', 'å¥³ç¥­ç¥€', 'å¥³çš‡', 'çš‡å¸', 'æ•™çš‡', 'æ‹äºº',
                'æˆ˜è½¦', 'åŠ›é‡', 'éšå£«', 'å‘½è¿ä¹‹è½®', 'æ­£ä¹‰', 'å€’åŠäºº', 'æ­»ç¥',
                'èŠ‚åˆ¶', 'é­”é¬¼', 'é«˜å¡”', 'æ˜Ÿæ˜Ÿ', 'æœˆäº®', 'å¤ªé˜³', 'å®¡åˆ¤', 'ä¸–ç•Œ'];
                
    const tarotCards = card_name.map((name, id) => ({ id, name }));

    // API
    function checkAPIKey() {
        if (!localStorage.getItem('apikey')) {
            const key = prompt('è¯·è¾“å…¥æ‚¨çš„DeepSeek APIå¯†é’¥ï¼š');
            if (key) localStorage.setItem('apikey', key);
            else alert('éœ€è¦APIå¯†é’¥æ‰èƒ½ä½¿ç”¨æœåŠ¡ï¼');
        }
    }
    checkAPIKey();

    let selectedCards = [];

    function startDivination() {
        document.getElementById('inputSection').style.display = 'none';
        document.getElementById('cardSelection').style.display = 'block';
        initCards();
        updateSelectionStatus();
    }

    function updateSelectionStatus() {
        const phases = ['èƒ½é‡ç‰Œ', 'å»ºè®®ç‰Œ', 'è­¦ç¤ºç‰Œ'];
        const currentStep = selectedCards.length;
        if (currentStep >= 3) {
            document.getElementById('selectionStatus').style.display = 'none';
            return;
        }
        document.getElementById('selectionStatus').innerHTML = 
            `æ­£åœ¨é€‰æ‹©${phases[currentStep]}ï¼ˆ${currentStep + 1}/3ï¼‰`;
    }

    function initCards() {
        const container = document.getElementById('cardsContainer');
        container.innerHTML = '';
        // æ‰“ä¹±tarotCards
        shuffledtarotCards = tarotCards.sort(() => Math.random() - 0.5);
        shuffledtarotCards.forEach(card => {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card';
            cardDiv.innerHTML = `
                <div class="card-inner">
                    <img src="assets/cover.jpg" class="card-back">
                    <img src="assets/${card.id}.gif" class="card-front">
                </div>
            `;
            
            cardDiv.onclick = () => {
                if (selectedCards.length >= 3 || cardDiv.classList.contains('flipped')) return;
                
                const isReversed = Math.random() < 0.5;
                cardDiv.classList.add('flipped');
                if (isReversed) {
                    cardDiv.querySelector('.card-front').classList.add('reversed');
                }
                
                selectedCards.push({
                    ...card,
                    reversed: isReversed,
                    role: ['èƒ½é‡', 'å»ºè®®', 'è­¦ç¤º'][selectedCards.length] // æ ¹æ®å½“å‰æ•°é‡è‡ªåŠ¨åˆ†é…è§’è‰²
                });
                
                updateSelectionStatus();
                document.getElementById('interpretBtn').disabled = selectedCards.length !== 3;
            };
            container.appendChild(cardDiv);
        });
    }

    // æç¤ºè¯ç”Ÿæˆå‡½æ•°
    function getCurrentTimeDescription() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();

        let period;
        if (hours >= 0 && hours < 6) period = "å‡Œæ™¨";
        else if (hours < 12) period = "ä¸Šåˆ";
        else if (hours < 18) period = "ä¸‹åˆ";
        else period = "æ™šä¸Š";

        return `${period}${hours % 12 || 12}ç‚¹${minutes}åˆ†`;
    }

    function get_prompt(aspect, cards) {
        return `ä½ æ˜¯ä¸€åä¸“æ³¨äºå¡”ç½—æ¯æ—¥æŒ‡å¼•çš„å åœå¸ˆï¼Œæ“…é•¿å°†å¤§é˜¿å°”å¡é‚£çš„è±¡å¾æ„ä¹‰è½¬åŒ–ä¸ºæ—¥å¸¸ç”Ÿæ´»å»ºè®®ã€‚  
    è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„ä»Šæ—¥æŠ½ç‰Œä¿¡æ¯ï¼Œä¸ºç”¨æˆ·è¿›è¡Œè§£è¯»ï¼š  

    **1. ç”¨æˆ·æŠ½ç‰Œ**ï¼š  
    - æŠ½ç‰Œæ•°é‡ï¼š3å¼ (èƒ½é‡/å»ºè®®/è­¦ç¤º)
    - ç‰Œé¢ä¿¡æ¯ï¼š
    1. èƒ½é‡ç‰Œï¼š${cards[0].name}${cards[0].reversed ? "é€†ä½" : "æ­£ä½"}  
    2. å»ºè®®ç‰Œï¼š${cards[1].name}${cards[1].reversed ? "é€†ä½" : "æ­£ä½"}  
    3. è­¦ç¤ºç‰Œï¼š${cards[2].name}${cards[2].reversed ? "é€†ä½" : "æ­£ä½"}  
    - é™„åŠ éœ€æ±‚ï¼šéœ€è¦èšç„¦ç‰¹å®šé¢†åŸŸï¼ˆ${aspect}ï¼‰  

    **2. ä½ çš„è§£è¯»ä»»åŠ¡**ï¼š  
    â‘  ä»Šæ—¥æ°”è¿ï¼ˆæ ¸å¿ƒèƒ½é‡åˆ†æï¼‰
    - ç”¨ä¸€å¥è¯æ€»ç»“ä»Šæ—¥æ•´ä½“åŸºè°ƒï¼ˆå¦‚â€œçªç ´æ—¥â€â€œç–—æ„ˆæ—¥â€â€œè°¨æ…æ—¥â€ï¼‰  
    - ç»“åˆç‰Œé¢ç¬¦å·ä¸æ­£é€†ä½ï¼Œè¿›è¡Œè¯¦ç»†åˆ†æ 

    â‘¡ ç»†åˆ†é¢†åŸŸæŒ‡å¼• ï¼ˆå¯ä»¥æ ¹æ®å†…å®¹æ›´æ”¹è¿™éƒ¨åˆ†æ ‡é¢˜ï¼‰
    - èƒ½é‡/ç°çŠ¶ï¼šä»Šæ—¥ä¸»å¯¼èƒ½é‡å¦‚ä½•å½±å“ç”Ÿæ´»  
    - å»ºè®®/æœºä¼šï¼šå…·ä½“è¡ŒåŠ¨æˆ–å¿ƒæ€è°ƒæ•´  
    - è­¦ç¤º/æŒ‘æˆ˜ï¼šéœ€è§„é¿çš„é£é™©æˆ–å¿ƒæ€  

    â‘¢ ä»Šæ—¥è¡ŒåŠ¨æ¸…å•ï¼ˆæ ¹æ®å½“å‰æ—¶é—´ï¼š${getCurrentTimeDescription()} ç»™å‡ºåˆç†å»ºè®®ï¼‰
    - ç»™å‡º1-3æ¡å¯ç«‹å³æ‰§è¡Œçš„å»ºè®®ï¼Œç”¨â€œâœ…â€å’Œâ€œâŒâ€åŒºåˆ†é¼“åŠ±ä¸é¿å…äº‹é¡¹ã€‚`;
    }

    async function interpretCards() {
        let btn = document.getElementById('interpretBtn');
        btn.disabled = true;
        let resultDiv = document.getElementById('result');
        resultDiv.style.visibility = 'visible';
        if (!localStorage.getItem('apikey')) return checkAPIKey();
        
        const aspect = document.getElementById('query').value || 'ç»¼åˆè¿åŠ¿';
        const prompt = get_prompt(aspect, selectedCards);
        //console.log(prompt);
        resultDiv.innerHTML = 'ğŸ”® æ­£åœ¨è§£è¯»ä¸­...';

        try {
            const response = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('apikey')}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{ role: "user", content: prompt }],
                    stream: true  // å¯ç”¨æµå¼ä¼ è¾“
                })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let resultText = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                
                // å¤„ç†æµå¼æ•°æ®å—
                chunk.split('\n').forEach(line => {
                    if (line.startsWith('data: ') && !line.includes('[DONE]')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            const content = data.choices[0]?.delta?.content || '';
                            resultText += content;
                            // å®æ—¶æ›´æ–°æ˜¾ç¤ºå†…å®¹
                            resultDiv.innerHTML = marked.parse(resultText + 'â–Œ');  // æ·»åŠ å…‰æ ‡æ•ˆæœ
                        } catch (e) {
                            console.error('è§£æé”™è¯¯:', e);
                        }
                    }
                });
            }
            
            // æœ€ç»ˆè§£æå®Œæ•´ç»“æœ
            resultDiv.innerHTML = marked.parse(resultText);
        } catch (error) {
            resultDiv.innerHTML = 'âš ï¸ è§£ç‰Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–APIå¯†é’¥';
            console.error('Error:', error);
        }
    }
</script>
</body>
</html>